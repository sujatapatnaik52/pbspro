version: '#{build}'
image: Visual Studio 2019
pull_requests:
  do_not_increment_build_number: true
clone_depth: 5
cache:
  - C:\projects\binaries -> .appveyor.yml, .appveyor
  - C:\projects\packages -> .appveyor.yml, .appveyor
configuration:
  - Debug
  #- Release
before_build:
  # - ps: choco install strawberryperl -y --no-progress --ignore-detected-reboot
  # - ps: choco install wixtoolset -y --no-progress --ignore-detected-reboot
  - cmd: wsl --user root /bin/bash -c "echo '[network]' >> /etc/wsl.conf; echo generateHosts = false >> /etc/wsl.conf"
  - cmd: wsl --user root cat /etc/wsl.conf
  - ps: $momhost = hostname
  - ps: $ip = [System.Net.Dns]::GetHostByName($env:computername).AddressList[0].IPAddressToString
  - ps: Add-Content C:\Windows\System32\Drivers\Etc\Hosts "$ip $momhost"
  - ps: wsl --user root /bin/bash -c "sed -i '1i $ip $momhost' /etc/hosts"
  - cmd: wsl --user root cp -r /mnt/c/projects/pbspro /mnt/c/Users/appveyor/ 
  #- cmd: wsl --user root /bin/bash -c "sudo sed -i 's/archive.ubuntu.com/us.archive.ubuntu.com/' /etc/apt/sources.list"
  - cmd: wsl --user root apt install -y apt-clone
  - cmd: wsl --user root /bin/bash -c "[ -f '/mnt/c/projects/packages/apt-clone-state-appveyor-vm.tar.gz' ] && { export DEBIAN_FRONTEND=noninteractive; apt-clone restore /mnt/c/projects/packages/apt-clone-state-appveyor-vm.tar.gz; } || echo hello"
  - cmd: wsl --user root /bin/bash -c "sed -i 's/archive.ubuntu.com/us.archive.ubuntu.com/' /etc/apt/sources.list; cd /mnt/c/Users/appveyor/pbspro; ./.travis/do.sh; mkdir /mnt/c/projects/packages; apt-clone clone /mnt/c/projects/packages; "
  #- cmd: wsl --user root /bin/bash -c "cd /mnt/c/Users/appveyor/pbspro; ./.travis/do1.sh"
build_script:
  - cmd: refreshenv
#on_finish:
#   - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
